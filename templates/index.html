<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenClaw Launcher ‚Äî X1 Validator Network</title>
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a28;
    --border: #2a2a3a;
    --text: #e0e0e8;
    --muted: #888898;
    --accent: #6366f1;
    --accent2: #818cf8;
    --green: #22c55e;
    --red: #ef4444;
    --orange: #f59e0b;
    --cyan: #06b6d4;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'SF Mono', 'Fira Code', 'JetBrains Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  .header {
    border-bottom: 1px solid var(--border);
    padding: 20px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .header h1 {
    font-size: 18px;
    font-weight: 600;
    letter-spacing: -0.5px;
  }

  .header h1 span { color: var(--accent2); }

  .header .stats {
    display: flex;
    gap: 24px;
    font-size: 13px;
    color: var(--muted);
  }

  .header .stats .val { color: var(--text); font-weight: 600; }

  .main { padding: 32px; max-width: 1200px; margin: 0 auto; }

  .launch-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 28px;
    margin-bottom: 32px;
  }

  .launch-panel h2 {
    font-size: 14px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 16px;
  }

  .launch-row {
    display: flex;
    gap: 12px;
    align-items: stretch;
  }

  .launch-row input {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    color: var(--text);
    font-family: inherit;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
  }

  .launch-row input:focus { border-color: var(--accent); }

  .launch-row input::placeholder { color: #555568; }

  .btn {
    padding: 14px 28px;
    border: none;
    border-radius: 8px;
    font-family: inherit;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
  }

  .btn-primary:hover { background: var(--accent2); }

  .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-danger {
    background: transparent;
    color: var(--red);
    border: 1px solid var(--red);
    padding: 6px 14px;
    font-size: 12px;
  }

  .btn-danger:hover { background: rgba(239,68,68,0.1); }

  .btn-sm {
    padding: 6px 14px;
    font-size: 12px;
    background: var(--surface2);
    color: var(--muted);
    border: 1px solid var(--border);
  }

  .btn-sm:hover { color: var(--text); border-color: var(--muted); }

  .instances-grid {
    display: grid;
    gap: 16px;
  }

  .instance-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px 24px;
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 16px;
    align-items: center;
    transition: border-color 0.2s;
  }

  .instance-card:hover { border-color: var(--accent); }

  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .status-dot.running { background: var(--green); box-shadow: 0 0 8px rgba(34,197,94,0.4); }
  .status-dot.stopped { background: var(--red); }
  .status-dot.starting { background: var(--orange); animation: pulse 1s infinite; }
  .status-dot.not_found { background: var(--muted); }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .instance-info { min-width: 0; }

  .instance-info .wallet {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    word-break: break-all;
  }

  .instance-info .meta {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
  }

  .instance-info .meta span { white-space: nowrap; }
  .instance-info .meta .label { color: #555568; }

  .instance-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-shrink: 0;
  }

  .dashboard-link {
    color: var(--cyan);
    text-decoration: none;
    font-size: 12px;
    font-weight: 600;
    padding: 6px 14px;
    border: 1px solid var(--cyan);
    border-radius: 8px;
    transition: all 0.2s;
  }

  .dashboard-link:hover { background: rgba(6,182,212,0.1); }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }

  .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
  .empty-state p { font-size: 14px; }

  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    padding: 14px 20px;
    border-radius: 8px;
    font-size: 13px;
    font-family: inherit;
    z-index: 100;
    animation: slideIn 0.3s ease;
    max-width: 400px;
  }

  .toast.error { background: var(--red); color: white; }
  .toast.success { background: var(--green); color: white; }

  @keyframes slideIn {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .logs-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 50;
  }

  .logs-content {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
  }

  .logs-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
  }

  .logs-body {
    padding: 16px 20px;
    overflow-y: auto;
    font-size: 12px;
    line-height: 1.6;
    color: var(--muted);
    white-space: pre-wrap;
    word-break: break-all;
  }

  .network-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    background: rgba(99,102,241,0.15);
    border-radius: 20px;
    font-size: 11px;
    color: var(--accent2);
    font-weight: 600;
  }

  /* File Editor Modal */
  .file-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 1000;
    display: flex;
    align-items: stretch;
    justify-content: stretch;
  }

  .file-modal-box {
    position: fixed;
    inset: 10px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .file-modal-header {
    padding: 14px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    font-size: 14px;
    flex-shrink: 0;
  }

  .file-modal-body {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  .file-sidebar {
    width: 220px;
    border-right: 1px solid var(--border);
    overflow-y: auto;
    padding: 12px 0;
    flex-shrink: 0;
  }

  .file-tab {
    display: block;
    width: 100%;
    padding: 10px 16px;
    cursor: pointer;
    font-size: 13px;
    color: var(--muted);
    background: none;
    border: none;
    text-align: left;
    font-family: inherit;
    transition: background 0.15s;
  }

  .file-tab:hover { color: var(--text); background: var(--surface2); }
  .file-tab.active { color: var(--accent); background: var(--surface2); }
  .file-tab.missing { opacity: 0.4; font-style: italic; }

  .file-content-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  #file-textarea {
    flex: 1;
    background: var(--bg);
    color: var(--text);
    border: none;
    outline: none;
    padding: 20px;
    font-family: inherit;
    font-size: 13px;
    line-height: 1.6;
    resize: none;
    width: 100%;
  }

  .file-footer {
    padding: 12px 20px;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    flex-shrink: 0;
  }
</style>
</head>
<body>

<div class="header">
  <h1>üêæ <span>OpenClaw</span> Launcher</h1>
  <div class="stats">
    <div>Instances <span class="val" id="stat-total">0</span></div>
    <div>Running <span class="val" id="stat-running">0</span></div>
    <div>Network <span class="network-badge">X1 Mainnet</span></div>
    <a href="/docs" style="margin-left: 16px; color: var(--accent2); text-decoration: none; font-size: 13px;">üìñ Docs</a>
  </div>
</div>

<div class="main">
  <div class="launch-panel">
    <h2>Deploy New Instance</h2>
    <div class="launch-row">
      <input type="text" id="pubkey-input" placeholder="Enter SVM wallet public key (e.g. 2jchoLFVoxmJUcygc2cDfAqQb1yWUEjJihsw2ARbDRy3)" maxlength="64" />
      <button class="btn btn-primary" id="launch-btn" onclick="launchInstance()">Deploy</button>
    </div>
  </div>

  <div id="instances-container">
    <div class="empty-state">
      <div class="icon">üì¶</div>
      <p>No instances deployed yet. Enter a wallet public key to launch.</p>
    </div>
  </div>
</div>

<div id="toast-container"></div>
<div id="modal-container"></div>

<script>
const HOST = window.location.origin;
let refreshInterval;

// Read auth token from URL param ?token=... and include in all API requests
const _urlToken = new URLSearchParams(window.location.search).get("token") || "";

function apiHeaders(extra) {
  const h = {"Content-Type": "application/json", ...(extra || {})};
  if (_urlToken) h["Authorization"] = "Bearer " + _urlToken;
  return h;
}

function apiFetch(url, opts) {
  opts = opts || {};
  opts.headers = apiHeaders(opts.headers || {});
  return fetch(url, opts);
}

function toast(msg, type = "success") {
  const el = document.createElement("div");
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.getElementById("toast-container").appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

function timeAgo(ts) {
  const s = Math.floor(Date.now() / 1000 - ts);
  if (s < 60) return `${s}s ago`;
  if (s < 3600) return `${Math.floor(s/60)}m ago`;
  if (s < 86400) return `${Math.floor(s/3600)}h ago`;
  return `${Math.floor(s/86400)}d ago`;
}

function truncWallet(w) {
  if (!w || w.length < 16) return w;
  return w.slice(0, 8) + "‚Ä¶" + w.slice(-6);
}

async function fetchInstances() {
  try {
    const res = await apiFetch(`${HOST}/api/instances`);
    const data = await res.json();
    renderInstances(data.instances);
  } catch (e) {
    console.error("Fetch failed:", e);
  }
}

function renderInstances(instances) {
  const total = instances.length;
  const running = instances.filter(i => i.status === "running").length;
  document.getElementById("stat-total").textContent = total;
  document.getElementById("stat-running").textContent = running;

  const container = document.getElementById("instances-container");
  if (!total) {
    container.innerHTML = `<div class="empty-state"><div class="icon">üì¶</div><p>No instances deployed yet. Enter a wallet public key to launch.</p></div>`;
    return;
  }

  container.innerHTML = `<div class="instances-grid">${instances.map(inst => {
    const statusClass = inst.status === "running" ? "running" : inst.status === "exited" ? "stopped" : inst.status;
    return `
      <div class="instance-card">
        <div class="status-dot ${statusClass}"></div>
        <div class="instance-info">
          <div class="wallet" title="${inst.pubkey}">${inst.pubkey}</div>
          <div class="meta">
            <span><span class="label">ID:</span> ${inst.id}</span>
            <span><span class="label">Port:</span> ${inst.port}</span>
            <span><span class="label">Status:</span> ${inst.status}</span>
            <span><span class="label">Created:</span> ${inst.created ? timeAgo(inst.created) : '‚Äî'}</span>
            <span class="stats-cell" id="stats-${inst.id}" style="color:var(--cyan)"></span>
          </div>
        </div>
        <div class="instance-actions">
          ${inst.status === "running" ?
            `<a class="dashboard-link" href="http://${location.hostname}:${inst.port}/" target="_blank">Dashboard</a>
             <button class="btn-sm" onclick="openFileEditor('${inst.id}','${inst.pubkey}')">üìù Files</button>
             <button class="btn-sm" onclick="viewLogs('${inst.id}')">Logs</button>
             <button class="btn-danger" onclick="stopInstance('${inst.pubkey}')">Stop</button>` :
            `<button class="btn btn-primary" style="padding:6px 14px;font-size:12px" onclick="relaunch('${inst.pubkey}')">Start</button>
             <button class="btn-danger" onclick="destroyInstance('${inst.pubkey}')">Destroy</button>`
          }
        </div>
      </div>`;
  }).join("")}</div>`;

  // Fetch live stats for each running instance
  instances.filter(i => i.status === "running").forEach(inst => {
    apiFetch(`${HOST}/api/stats/${inst.id}`)
      .then(r => r.json())
      .then(d => {
        const el = document.getElementById(`stats-${inst.id}`);
        if (el && d.stats && d.stats.cpu) {
          el.textContent = `CPU: ${d.stats.cpu} ¬∑ MEM: ${d.stats.mem}`;
        }
      })
      .catch(() => {});
  });
}

async function launchInstance() {
  const input = document.getElementById("pubkey-input");
  const btn = document.getElementById("launch-btn");
  const pubkey = input.value.trim();

  if (!pubkey || pubkey.length < 32) {
    toast("Enter a valid SVM wallet public key (32-44 chars)", "error");
    return;
  }

  btn.disabled = true;
  btn.textContent = "Deploying‚Ä¶";

  try {
    const res = await apiFetch(`${HOST}/api/launch`, {
      method: "POST",
      body: JSON.stringify({ pubkey })
    });
    const data = await res.json();
    if (data.error) {
      toast(data.error, "error");
    } else {
      toast(`Instance deployed on port ${data.instance.port}`);
      input.value = "";
      fetchInstances();
    }
  } catch (e) {
    toast("Network error", "error");
  } finally {
    btn.disabled = false;
    btn.textContent = "Deploy";
  }
}

async function stopInstance(pubkey) {
  try {
    const res = await apiFetch(`${HOST}/api/stop`, {
      method: "POST",
      body: JSON.stringify({ pubkey })
    });
    const data = await res.json();
    toast(data.error || "Instance stopped");
    fetchInstances();
  } catch (e) { toast("Failed", "error"); }
}

async function destroyInstance(pubkey) {
  if (!confirm("Destroy this instance? Container will be removed. Workspace files are preserved on disk.")) return;
  try {
    const res = await apiFetch(`${HOST}/api/destroy`, {
      method: "POST",
      body: JSON.stringify({ pubkey })
    });
    toast("Instance destroyed");
    fetchInstances();
  } catch (e) { toast("Failed", "error"); }
}

async function relaunch(pubkey) {
  try {
    const res = await apiFetch(`${HOST}/api/launch`, {
      method: "POST",
      body: JSON.stringify({ pubkey })
    });
    const data = await res.json();
    toast(data.error || `Restarted on port ${data.instance?.port}`);
    fetchInstances();
  } catch (e) { toast("Failed", "error"); }
}

async function viewLogs(instanceId) {
  try {
    const res = await apiFetch(`${HOST}/api/logs/${instanceId}?lines=100`);
    const data = await res.json();
    const modal = document.getElementById("modal-container");
    modal.innerHTML = `
      <div class="logs-modal" onclick="if(event.target===this)this.remove()">
        <div class="logs-content">
          <div class="logs-header">
            <span>Logs ‚Äî ${instanceId}</span>
            <button class="btn-sm" onclick="this.closest('.logs-modal').remove()">Close</button>
          </div>
          <div class="logs-body">${escHtml(data.logs || "No logs")}</div>
        </div>
      </div>`;
  } catch (e) { toast("Failed to fetch logs", "error"); }
}

function escHtml(s) {
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function toggleToken(btn) {
  const span = btn.previousElementSibling;
  const full = span.dataset.token;
  if (btn.textContent === "Reveal") {
    span.textContent = full;
    btn.textContent = "Hide";
  } else {
    span.textContent = full.slice(0,8) + "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
    btn.textContent = "Reveal";
  }
}

let _fileEditorIid = null;
let _fileEditorFilename = null;

async function openFileEditor(iid, pubkey) {
  _fileEditorIid = iid;
  _fileEditorFilename = null;
  const modal = document.getElementById("modal-container");
  const label = truncWallet(pubkey);

  modal.innerHTML = `
    <div class="file-modal" onclick="if(event.target===this)this.remove()">
      <div class="file-modal-box">
        <div class="file-modal-header">
          <span>Agent Files ‚Äî ${label}</span>
          <button class="btn-sm" onclick="this.closest('.file-modal').remove()">‚úï Close</button>
        </div>
        <div class="file-modal-body">
          <div class="file-sidebar" id="file-sidebar">
            <div style="padding:16px;color:var(--muted);font-size:12px">Loading‚Ä¶</div>
          </div>
          <div class="file-content-area">
            <textarea id="file-textarea" placeholder="Select a file to edit‚Ä¶"></textarea>
            <div class="file-footer">
              <button class="btn btn-primary" style="padding:8px 20px;font-size:13px" onclick="saveFile()">üíæ Save</button>
              <span id="file-status" style="font-size:12px;color:var(--muted);margin-left:12px"></span>
            </div>
          </div>
        </div>
      </div>
    </div>`;

  // Load file list
  try {
    const res = await apiFetch(`${HOST}/api/files/${iid}`);
    const data = await res.json();
    const knownFiles = ["SOUL.md","AGENTS.md","USER.md","MEMORY.md","HEARTBEAT.md","IDENTITY.md","TOOLS.md"];
    const allFiles = [...new Set([...knownFiles, ...(data.files || [])])];
    const existSet = new Set(data.files || []);
    document.getElementById("file-sidebar").innerHTML = allFiles.map(f =>
      `<button class="file-tab${existSet.has(f) ? "" : " missing"}" onclick="loadFile('${f}')">${f}</button>`
    ).join("");
    // Auto-open first existing file
    const first = allFiles.find(f => existSet.has(f));
    if (first) loadFile(first);
  } catch(e) {
    document.getElementById("file-sidebar").innerHTML = `<div style="padding:16px;color:var(--red);font-size:12px">Failed to load</div>`;
  }
}

async function loadFile(filename) {
  if (!_fileEditorIid) return;
  _fileEditorFilename = filename;
  // Highlight active tab
  document.querySelectorAll(".file-tab").forEach(t => {
    t.classList.toggle("active", t.textContent === filename);
  });
  const ta = document.getElementById("file-textarea");
  if (!ta) return;
  ta.value = "Loading‚Ä¶";
  document.getElementById("file-status").textContent = "";
  try {
    const res = await apiFetch(`${HOST}/api/files/${_fileEditorIid}/${filename}`);
    const data = await res.json();
    ta.value = data.content || "";
  } catch(e) {
    ta.value = "";
    document.getElementById("file-status").textContent = "Failed to load";
  }
}

async function saveFile() {
  if (!_fileEditorIid || !_fileEditorFilename) return;
  const ta = document.getElementById("file-textarea");
  const status = document.getElementById("file-status");
  if (!ta || !status) return;
  status.textContent = "Saving‚Ä¶";
  try {
    const res = await apiFetch(`${HOST}/api/files/${_fileEditorIid}/${_fileEditorFilename}`, {
      method: "PUT",
      body: JSON.stringify({content: ta.value})
    });
    const data = await res.json();
    status.style.color = data.ok ? "var(--green)" : "var(--red)";
    status.textContent = data.ok ? "Saved ‚úì" : (data.error || "Error");
    setTimeout(() => { if(status) status.textContent = ""; }, 3000);
  } catch(e) {
    status.style.color = "var(--red)";
    status.textContent = "Network error";
  }
}

// Init
fetchInstances();
refreshInterval = setInterval(fetchInstances, 5000);

// Enter key
document.getElementById("pubkey-input").addEventListener("keydown", e => {
  if (e.key === "Enter") launchInstance();
});
</script>
</body>
</html>
